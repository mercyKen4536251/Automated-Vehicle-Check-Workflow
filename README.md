# 自动化车辆审核工作流

基于VLM模型的自动化车辆审核系统，通过5个智能体节点进行多维度图像审核。

## 📋 目录

- [快速开始](#快速开始)
- [核心功能](#核心功能)
- [使用流程](#使用流程)
- [审图工作流](#审图工作流)
- [工程结构](#工程结构)
- [版本更新](#版本更新)

## 快速开始

### 环境要求
- Python 3.10+
- Streamlit
- Pandas
- 火山引擎API Key

### 安装与运行

```bash
# 安装依赖
pip install -r requirements.txt

# 启动应用
streamlit run app.py
```

应用将在 `http://localhost:8501` 启动

## 核心功能

### ⚙️ 配置管理
- **模型配置**：支持多个模型配置，可随时切换激活模型
- **思考模式**：支持启用/禁用模型思考模式
- **问题标签**：管理badcase问题标签，标记预期过滤节点

### 🧩 提示词管理
- 管理5个节点对应的审核提示词
- 支持版本管理（创建、更新、激活）
- 实时预览提示词内容

### 🖼️ 参考图库管理
- 为每个车系添加标准参考图（最多5张）
- 支持图片预览、编辑、删除
- 用于视角和细节一致性比对

### 📋 测试用例管理
- 管理goodcase和badcase
- 支持问题标签标注（仅badcase）
- 多维度筛选（车系、类型、标签）
- 支持批量删除

### 🚀 运行中心
- 批量执行测试用例
- 多线程并发处理（最多3个并发）
- 实时进度显示
- 多维度筛选（车系、类型、标签）

### 📊 结果面板
- **测试记录**：查看历史测试记录，支持删除
- **详细结果**：查看单次测试的详细数据
  - 核心指标：测试总数、通过数、审图准确率、节点有效率
  - 配置信息：使用的模型、思考模式、提示词版本
  - 详细列表：支持多维度筛选，展示基础信息、图片预览、模型输出

## 使用流程

### 第一步：配置模型
1. 进入「配置管理」页面
2. 在「模型配置」中添加火山引擎API Key
3. 配置思考模式（可选）

### 第二步：设置提示词
1. 进入「提示词管理」页面
2. 为5个节点分别配置提示词
3. 激活需要使用的提示词版本

### 第三步：添加参考图
1. 进入「参考图库管理」页面
2. 为各车系上传标准参考图（最多5张）
3. 支持预览、编辑、删除

### 第四步：创建测试用例
1. 进入「测试用例管理」页面
2. 添加goodcase和badcase
3. 为badcase标注问题标签

### 第五步：执行测试
1. 进入「运行中心」页面
2. 使用筛选器快速定位需要测试的用例
3. 勾选要测试的用例
4. 点击「执行测试」开始测试

### 第六步：分析结果
1. 进入「结果面板」页面
2. 在「测试记录」中查看历史记录
3. 点击「查看详情」进入「详细结果」
4. 使用筛选器分析失败原因

## 审图工作流

系统采用5节点串联审图流程，每个节点的判定结果决定是否继续到下一节点：

| 节点 | 功能 | 判定标准 | 通过条件 |
|------|------|--------|--------|
| Node1 | 汽车检测 | 判断是否存在可用汽车 | `car="yes"` |
| Node2 | 裁切检测 | 判断车身是否被裁切 | `cropping="no"` |
| Node3 | 运动/无人驾驶检测 | 判断是否有车牌文字或无人驾驶 | `match="yes"` |
| Node4 | 视角一致性 | 判断与参考图视角是否一致 | `match="yes"` |
| Node5 | 细节一致性 | 判断与参考图细节是否一致 | `match="yes"` |

**最终结果说明**：
- `final_pass="yes"`：通过所有审核，质量合格
- `final_pass="no"`：在某个节点被明确判定为不合格
- `final_pass="unknown"`：无法判定（如Node4找不到匹配视角）

## 工程结构

```
.
├── app.py                          # 主应用入口
├── requirements.txt                # 依赖配置
├── README.md                       # 项目文档
├── VERSION.md                      # 版本历史
├── AGENTS.md                       # AI工程文档
├── LICENSE                         # 许可证
│
├── data/                           # 数据目录
│   ├── model_config.csv           # 模型配置数据
│   ├── problem_tags.csv           # 问题标签数据
│   ├── prompt_01.csv ~ prompt_05.csv  # 5个节点的提示词
│   ├── ref.csv                    # 参考图库数据
│   ├── test_cases.csv             # 测试用例数据
│   └── test_history/              # 测试历史记录（JSON）
│
├── src/                            # 核心模块
│   ├── config_manager.py          # 模型配置管理
│   ├── data_manager.py            # 数据管理（CSV操作）
│   ├── history_manager.py         # 测试历史管理
│   ├── model_client.py            # VLM模型客户端
│   └── workflow_engine.py         # 5节点工作流引擎
│
├── pages/                          # Streamlit页面
│   ├── manage/                    # 管理页面
│   │   ├── config.py              # 配置管理
│   │   ├── prompt.py              # 提示词管理
│   │   ├── ref_gallery.py         # 参考图库管理
│   │   └── test_cases.py          # 测试用例管理
│   └── test/                      # 测试页面
│       ├── run_test.py            # 运行中心
│       └── result.py              # 结果面板
│
└── 0-Notes/                        # 项目笔记
    └── Todo.md                    # 待办事项
```

## 版本更新

详见 [VERSION.md](VERSION.md)

### 最新版本：v1.4.0

主要改动：
- 模型客户端重构，优化消息结构
- 工作流引擎优化，提高业务逻辑清晰度
- 节点有效率指标完善
- 结果面板重构，改进用户体验

[查看完整版本历史 →](VERSION.md)

## 开发指南

### 代码规范
- 语言：Python 3.10+
- 框架：Streamlit
- 文档字符串：中文，包含Args/Returns说明
- 命名：snake_case（函数/变量），PascalCase（类）
- 字符串：双引号
- 代码分区：使用 `=` 分隔符

### 常用命令
```bash
# 安装依赖
pip install -r requirements.txt

# 运行应用
streamlit run app.py

# 清除缓存
streamlit cache clear
```

## 许可证

见 [LICENSE](LICENSE) 文件

