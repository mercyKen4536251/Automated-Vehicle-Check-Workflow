# 自动化车辆审核工作流 (Automated Vehicle Check Workflow)

**当前版本：v1.2.0**

[![Python](https://img.shields.io/badge/Python-3.10+-blue.svg)](https://www.python.org/)
[![Streamlit](https://img.shields.io/badge/Streamlit-Latest-orange.svg)](https://streamlit.io/)
[![License](https://img.shields.io/badge/License-MIT-green.svg)](LICENSE)

## 项目简介

基于VLM模型的自动化车辆审核工作流系统。
旨在通过5个智能体节点的多维审核，保证待审核图符合规范标准。
系统支持提示词版本管理、参考图库管理、测试用例管理以及批量测试执行，并提供详细的测试结果分析和历史记录追踪。

## 核心功能

### 🧩 提示词管理

管理5个智能体节点对应的提示词，支持版本管理：

- **节点1 - 汽车检测**: 判断图片中是否存在汽车
- **节点2 - 裁切检测**: 判断车身是否被裁切
- **节点3 - 运动/无人驾驶检测**: 判断是否为运动状态或无人驾驶
- **节点4 - 视角一致性**: 判断生成图与参考图视角是否一致
- **节点5 - 细节一致性**: 判断生成图与参考图细节是否一致

**功能特性**：
- 支持提示词版本管理（创建、更新、激活）
- 每个节点可维护多个版本
- 实时编辑和保存
- 版本历史查看

### 🖼️ 参考图库管理

管理不同车系的标准参考图：

- 每个车系最多支持5张参考图
- 支持弹窗式新增、编辑、预览
- 支持多选删除
- 参考图用于节点4和节点5的比对

### 📋 测试用例管理

管理待审核的测试用例：

- **问题标签管理**: 创建和管理问题标签（如：裁切、车牌文字、无人驾驶等）
- **用例管理**: 弹窗式新增、编辑、删除测试用例
- **用例分类**: 支持 goodcase（预期通过）和 badcase（预期失败）
- **标签标注**: 为badcase标注问题类型
- **车系关联**: 每个用例关联到具体车系
- **图片预览**: 弹窗式查看用例图片
- **多维度筛选**: 按车系、类型、标签筛选用例
- **多选操作**: 支持批量选择和删除

### 🚀 运行中心

执行自动化测试：

- **用例选择**: 支持多选测试用例
- **多维度筛选**: 按车系、类型、标签筛选
- **并发执行**: 使用3线程并发执行，提高效率
- **实时进度**: 显示测试进度和实时结果
- **自动保存**: 测试完成后自动保存历史记录

### 📊 结果面板

查看和分析测试结果：

**当前测试结果**：
- 核心指标展示（测试总数、通过数、准确率）
- 详细结果列表（支持筛选：全部/仅错误/仅正确）
- 每个用例的完整JSON数据展示

**历史测试记录**：
- 历史测试列表（按时间倒序）
- 每次测试的详细信息
- 历史记录删除功能

## 使用流程

### 首次使用

1. **配置API Key**
   - 访问[火山引擎控制台](https://console.volcengine.com/ark)获取API Key
   - 在应用中添加模型配置

2. **配置提示词**
   - 进入"提示词管理"页面
   - 为5个节点分别配置提示词
   - 保存并激活提示词版本

3. **添加参考图**
   - 进入"参考图库管理"页面
   - 为各车系添加标准参考图（每车系最多5张）

4. **管理标签**
   - 进入"测试用例管理"页面
   - 添加问题标签（如：裁切、车牌文字、无人驾驶等）

5. **添加测试用例**
   - 在"测试用例管理"页面添加用例
   - 选择车系、用例类型、问题标签
   - 输入图片URL

### 日常使用

1. **运行测试**
   - 进入"运行中心"页面
   - 筛选并勾选要测试的用例
   - 点击"执行测试"
   - 等待测试完成

2. **查看结果**
   - 进入"结果面板"页面
   - 查看当前测试结果
   - 分析准确率和失败原因

3. **优化调整**
   - 根据测试结果优化提示词
   - 添加新的测试用例
   - 调整参考图库

## 安装和配置

### 1. 环境要求

- Python 3.10 或更高版本
- 火山引擎 API Key（用于调用大模型）

### 2. 安装依赖

```bash
pip install -r requirements.txt
```

依赖包包括：
- `streamlit` - Web应用框架
- `pandas` - 数据处理
- `volcengine-python-sdk[ark]` - 火山引擎Ark API SDK

### 3. 配置API Key

#### 3.1 获取API Key

1. 访问[火山引擎控制台](https://console.volcengine.com/ark)
2. 登录并进入ARK服务
3. 创建或选择模型
4. 获取API Key和模型ID

#### 3.2 在应用中配置

1. 运行应用后，访问首页
2. 点击左侧导航栏的 **"提示词管理"**
3. 在页面中找到模型配置区域
4. 点击 **"➕ 添加配置"** 按钮
5. 填写以下信息：
   - **模型ID**: 从火山引擎控制台获取的模型ID
   - **API Key**: 从火山引擎控制台获取的API Key
   - **思考模式**: 选择 `enabled` 或 `disabled`（建议使用 `disabled` 以提高响应速度）
6. 点击保存

### 4. 数据目录说明

首次运行后，系统会在 `data/` 目录下自动创建以下文件：

- `model_config.csv` - 模型配置（**包含API Key，已加入.gitignore，不会提交到Git**）
- `prompt_01.csv` ~ `prompt_05.csv` - 5个节点的提示词（支持版本管理）
- `ref.csv` - 参考图库（各车系的标准参考图）
- `test_cases.csv` - 测试用例（goodcase/badcase）
- `problem_tags.csv` - 问题标签
- `test_history/` - 测试历史记录（JSON格式）

### 5. 启动应用

```bash
streamlit run app.py
```

应用将在浏览器中自动打开，默认地址为 `http://localhost:8501`

### 6. 注意事项

- ⚠️ **安全警告**: `data/model_config.csv` 包含敏感信息（API Key），已加入 `.gitignore`，不会提交到版本库
- ⚠️ **代码提交**: 提交代码前，请确保不要包含真实的API Key
- 📝 **自动创建**: 所有配置文件都会在首次运行时自动创建
- 🔄 **配置切换**: 支持多模型配置，可以在不同模型之间切换

## 版本历史

### v1.0.0 (2025-01-12)

**初始版本发布**

**核心功能**：
- ✅ 实现5节点审图工作流
- ✅ 支持模型配置管理（多配置支持）
- ✅ 支持提示词版本管理
- ✅ 支持参考图库管理
- ✅ 支持测试用例管理
- ✅ 支持批量测试执行（并发）
- ✅ 支持测试结果统计和历史记录

### v1.1.0 (2025-01-12)

**界面逻辑优化**

- ✅ 优化整体界面布局和交互逻辑
- ✅ 改进用户体验和操作流程

### v1.2.0 (2025-01-13)

**参考图库管理**：
- ✅ 新增弹窗式新增、编辑、预览功能
- ✅ 改用多选表格，支持批量删除
- ✅ 添加删除确认机制
- ✅ 优化操作按钮布局

**测试用例管理**：
- ✅ 新增弹窗式新增、编辑、预览功能
- ✅ 新增多维度筛选（车系、类型、标签）
- ✅ 改用多选表格，支持批量删除
- ✅ 添加删除确认机制
- ✅ 新增用例时继承最后一条数据的默认值

**运行中心**：
- ✅ 新增多维度筛选（车系、类型、标签）
- ✅ 改用多选表格，优化用例选择流程

## 审图工作流（最新版）

1. **Node 1 - 汽车检测**: 判断图片中是否存在汽车 (car="yes"才通过)
2. **Node 2 - 裁切检测**: 判断车身是否被裁切 (cropping="no"才通过)
3. **Node 3 - 运动/无人驾驶检测**: 判断是否为运动状态或无人驾驶 (match="yes"才通过)
4. **Node 4 - 视角一致性**: 判断生成图与参考图视角是否一致 (match="yes"才通过)
5. **Node 5 - 细节一致性**: 判断生成图与参考图细节是否一致 (match="yes"才通过)

## 项目结构（最新版）

```
├── app.py                    # 应用入口（Streamlit导航）
├── requirements.txt          # 项目依赖
├── README.md                # 项目说明文档
├── LICENSE                  # 开源协议
├── pages/                   # 功能页面目录
│   ├── manage/              # 管理功能页面
│   │   ├── prompt.py        # 提示词管理
│   │   ├── ref_gallery.py   # 参考图库管理
│   │   └── test_cases.py    # 测试用例管理
│   └── test/                # 测试功能页面
│       ├── run_test.py      # 运行测试
│       └── result.py        # 结果面板
├── src/                     # 核心逻辑模块
│   ├── config_manager.py    # 配置管理
│   ├── data_manager.py      # 数据管理
│   ├── history_manager.py   # 历史记录管理
│   ├── model_client.py      # 模型客户端
│   └── workflow_engine.py   # 工作流引擎
└── data/                    # 数据存储目录
    ├── model_config.csv     # 模型配置（敏感，已加入.gitignore）
    ├── prompt_01.csv ~ prompt_05.csv  # 5个节点的提示词
    ├── ref.csv              # 参考图库
    ├── test_cases.csv       # 测试用例
    ├── problem_tags.csv     # 问题标签
    └── test_history/        # 测试历史记录（JSON格式）
```